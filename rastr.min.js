;function RastrTools(){"use strict";var m,maxSide,lyrSize,lyrsCnt,onErr;onErr=code=>(code>0?(void(this.onError&&this.onError(code)),false):true);this.onError=null;this.reset=function(useSingleLayer){m.mem_internal_init(useSingleLayer);maxSide=m.layers_get_max_side_size();lyrsCnt=m.layers_get_max_layers_count();lyrSize=maxSide*maxSide*4;};this.reload=function(url,cb,user,pswrd){RastrTools.fetch(url,"arraybuffer",b=>{if(WebAssembly.validate(b)){WebAssembly.instantiate(b,{env:{}}).then(res=>{m=res.instance.exports;cb(null);}).catch(cb);}else{cb(new Error("Module is invalid"));}},user,pswrd);};this.palette={apply:(lyr,skipAlpha)=>m.palette_apply(lyr>>>0,skipAlpha|0),resize:size=>m.palette_resize(size>>>0),getSize:()=>m.palette_get_size(),getMaxSize:()=>m.palette_get_max_size(),findNearestColor:(clr,skipAlpha)=>m.palette_find_nearest_color(clr>>>0,skipAlpha|0),getRaw:()=>new Uint32Array(m.memory.buffer,m.palette_get(),m.palette_get_size()<<2)};var at=(x,y,w)=>(x+y*w)|0;var lyrBytes=addr=>new Uint8ClampedArray(m.memory.buffer,addr,m.layers_get_size()<<2);this.layers={channelMove:(lyr,ch,val)=>m.channel_move(lyr>>>0,ch|0,val|0),channelSet:(lyr,ch,val)=>m.channel_set(lyr>>>0,ch|0,val>>>0),channelClampUp:(lyr,ch,val)=>m.channel_clamp_up(lyr>>>0,ch|0,val>>>0),channelClampDown:(lyr,ch,val)=>m.channel_clamp_down(lyr>>>0,ch|0,val>>>0),colorGetCount:lyr=>m.colors_get_count(lyr>>>0)>>>0,colorGetAll:lyr=>new Uint32Array(lyrBytes(m.layers_get_extra()).slice(0,m.colors_get_count(lyr>>>0)<<2).buffer),colorGetAt:(lyr,x,y,badColor)=>m.color_get_at(lyr>>>0,x>>>0,y>>>0,badColor>>>0)>>>0,colorClear:(lyr,clr)=>m.clear(lyr>>>0,clr>>>0),colorReplace:(lyr,dest,src)=>1===m.replace(lyr>>>0,dest>>>0,src>>>0),copyLayer:(dest,src)=>1===m.copy(dest>>>0,src>>>0,0),moveClip:(lyr,x,y,frame_x,frame_y,frame_w,frame_h,clear,clrColor)=>m.move(lyr>>>0,x|0,y|0,frame_x>>>0,frame_y>>>0,frame_w>>>0,frame_h>>>0,clear|0,clrColor>>>0),floodFill:(lyr,clr,x,y)=>1===m.fill(lyr>>>0,x>>>0,y>>>0,clr>>>0),flip:lyr=>m.flip(lyr>>>0),mirror:lyr=>m.mirror(lyr>>>0),getImageData:lyr=>new ImageData(lyrBytes(lyr>>>0),m.layers_get_width(),m.layers_get_height()),copyToImageData:(lyr,x,y,imageData)=>{var i,j,lw,lh,bits;lw=m.layers_get_width();lh=m.layers_get_height();if(0===x&&0===y&&lw===imageData.width&&lh===imageData.height){imageData.data.set(lyrBytes(lyr>>>0),0);return true;}else if(x>=0&&y>=0&&x+imageData.width<=lw&&y+imageData.height<=lh){j=0;i=at(x,y,lw);bits=lyrBytes(lyr>>>0);y=0;while(y++<imageData.height){imgData.data.set(bits.subarray(i<<2,(i+imageData.width)<<2),j<<2);i+=lw;j+=imageData.width;}
return true;}
return false;},putImageData:(lyr,imageData,x,y,force)=>{var i,j,x_,y_,addr,bits,extra,imgWidth,imgHeight,lyrWidth,lyrHeight,offsetX,offsetY;x_=x|0;y_=y|0;addr=lyr>>>0;extra=m.layers_get_extra();imgWidth=imageData.width;imgHeight=imageData.height;bits=force?lyrBytes(addr):lyrBytes(extra);lyrWidth=m.layers_get_width();lyrHeight=m.layers_get_height();if(0===x_&&0===y_&&imgWidth===lyrWidth&&imgHeight===lyrHeight){bits.set(imageData.data);}else{if(x_>=0&&y_>=0&&lyrWidth>=(x_+imgWidth)&&lyrHeight>=(y_+imgHeight)){j=0;m.clear_in_range(extra,extra+lyrWidth*lyrHeight,0);}else{offsetX=offsetY=0;if((x+imgWidth)>lyrWidth){imgWidth=Math.abs(lyrWidth-x);}
if((y+imgHeight)>lyrHeight){imgHeight=Math.abs(lyrHeight-y);}
if(x<0){offsetX=-x;imgWidth-=offsetX;x=0;}
if(y<0){offsetY=-y;imgHeight-=offsetY;y=0;}
j=at(offsetX,offsetY,imageData.width);}
i=at(x,y,lyrWidth);y_=0;while(y_++<imgHeight){bits.set(imageData.data.subarray(j<<2,(j+imgWidth)<<2),i<<2);i+=lyrWidth;j+=imageData.width;}}
if(!force){m.copy(addr,extra,0);}},resizeAll:(lyrs,offsetX,offsetY,width,height)=>{var i,lyr,oldW,oldH,extra,oldSize;oldW=m.layers_get_width();oldH=m.layers_get_height();if(oldW===width&&oldH===height)return false;m.layers_resize(width>>>0,height>>>0);if(Array.isArray(lyrs)&&lyrs.length<=lyrsCnt){i=lyr=0>>>0;extra=m.layers_get_extra();oldSize=(oldW*oldH)<<2;while(i<lyrs.length){lyr=lyrs[i++]>>>0;m.copy_in_range(extra,extra+oldSize,lyr);m.clear_in_range(lyr,lyr+oldSize,0);m.put_image(lyr,extra,offsetX|0,offsetY|0,oldW>>>0,oldH>>>0);}}
return onErr(m.vertices_build_default());},getWidth:()=>m.layers_get_width()>>>0,getHeight:()=>m.layers_get_height()>>>0,getMaxSideSize:()=>maxSide>>>0,getMinSideSize:()=>1>>>0,filter:(lyr,op,v)=>m.filter(lyr>>>0,op|0,+v),filterCustom:(lyr,v0,v1,v2,v5,v6,v7,v10,v11,v12)=>m.filter_custom_matrix(lyr>>>0,+v0,+v1,+v2,+v5,+v6,+v7,+v10,+v11,+v12),globalCompositeOperationSet:op=>m.compose_set_operation(op|0),globalCompositeOperationGet:()=>m.compose_get_operation()|0,strokePrepare:()=>m.stroke_prepare(),strokeFinish:()=>m.stroke_finish(),strokeLine:(lyr,x0,y0,x1,y1,w,clr)=>m.stroke_line(lyr>>>0,x0|0,y0|0,x1|0,y1|0,w>>>0,clr>>>0),strokeRectangle:(lyr,x0,y0,x1,y1,clr)=>m.stroke_rectangle(lyr>>>0,x0|0,y0|0,x1|0,y1|0,clr>>>0),strokeEllipse:(lyr,x0,y0,x1,y1,clr)=>m.stroke_ellipse(lyr>>>0,x0|0,y0|0,x1|0,y1|0,clr>>>0),getAddr:ind=>(ind>=0||ind<lyrsCnt?m.layers_get()+lyrSize*ind:0)>>>0,getMaxCount:()=>lyrsCnt>>>0};this.vertices={getClipRectangle:()=>({x:m.get_working_area_x()>>>0,y:m.get_working_area_y()>>>0,width:m.get_working_area_width()>>>0,height:m.get_working_area_height()>>>0}),buildDefault:()=>onErr(m.vertices_build_default()),prepareBuild:()=>1===m.vertices_prepare_build(),add:(x,y)=>1===m.vertices_add(x|0,y|0),finishBuild:()=>onErr(m.vertices_finish_build()),move:(x,y)=>onErr(m.vertices_move(x|0,y|0)),getMaxCount:()=>m.vertices_get_max_count(),getCount:()=>m.vertices_get_count(),getRaw:()=>new Int16Array(m.memory.buffer,m.vertices_get(),m.vertices_get_count()<<1)};var cursor=0;var items=[];var push=item=>{if(items.length>=100)items.shift().free();return(cursor=items.push(item));};var on_size_swap=err=>this.history.onSizeSwap&&this.history.onSizeSwap(err);var on_layer_swap=i=>this.history.onLayerSwap&&this.history.onLayerSwap(i>>>0);var on_custom_swap=(type,data)=>this.history.onCustomSwap&&this.history.onCustomSwap(type,data);var swap=i=>onErr(-1===i?0:items[i].swap());this.history={onLayerSwap:null,onSizeSwap:null,onCustomSwap:null,saveLayer:lyr=>{var item=new Layer(lyr);return item.save()&&!!push(item);},saveSize:(lyrs,width,height)=>{var i,item;i=0;item=new Size(width,height);while(i<lyrs.length)
if(!item.save(new Layer(lyrs[i++]))){item.free();return false;}
return!!push(item);},saveCustom:(type,data)=>{var item=new Custom(type);item.save(data);return!!push(item);},undo:()=>swap(cursor>0?--cursor:-1),redo:()=>swap(cursor<items.length?cursor++:-1),drop:cnt=>{var i=cnt|0;if(i<0){i=-i;while(i--&&items.length)items.pop().free();}else{while(i--&&items.length)items.shift().free();}
if(cursor>items.length)cursor=items.length;},getItemsCount:()=>items.length>>>0,getCursor:()=>cursor>>>0,getFreeBytes:()=>m.get_free_bytes()>>>0,getMaxStrLength:()=>255};function Layer(addr){this.page=0>>>0;this.layer=addr>>>0;};Layer.prototype._saveLayer=function(flag){var addr=m.layers_get_extra()>>>0;return m.history_save(addr,m.compression_compress(addr,addr+lyrSize,this.layer,flag|0))>>>0;};Layer.prototype.save=function(compressWholeLayer){return!!(this.page=this._saveLayer(compressWholeLayer));};Layer.prototype.swap=function(width,height){var err,oldW,oldH,page,hasWH;hasWH=arguments.length>1;page=this._saveLayer(hasWH);if(0===page){return 0;}
if(hasWH){oldW=m.layers_get_width();oldH=m.layers_get_height();m.layers_resize(width,height);}
err=m.compression_decompress(m.get_history_data_at(this.page),this.layer);if(0!==err){Layer.prototype.free.call({page:page>>>0});return err;}else if(hasWH){m.layers_resize(oldW>>>0,oldH>>>0);}
this.free();this.page=page>>>0;on_layer_swap(this.layer);return 0;};Layer.prototype.free=function(){m.history_mark_pages(this.page,0>>>0);};function Size(width,height){this.width=width>>>0;this.height=height>>>0;this.layerItems=[];};Size.prototype.save=function(layerItem){if(layerItem.save(true)){this.layerItems.push(layerItem);return true;}
return false;};Size.prototype.swap=function(){let i=0;let err=0;while(i<this.layerItems.length){err=this.layerItems[i++].swap(this.width,this.height);if(0!==err){void(onErr(err));on_size_swap(err);}}
const width=m.layers_get_width();const height=m.layers_get_height();m.layers_resize(this.width,this.height);m.vertices_build_default();this.width=width;this.height=height;if(0===err)on_size_swap(err);return err;};Size.prototype.free=function(){while(this.layerItems.length)this.layerItems.pop().free();};function Custom(type){this.type=type;this.free();}
Custom.prototype.save=function(data){this.data=data;};Custom.prototype.swap=function(){this.data=on_custom_swap(this.type,this.data);return 0;};Custom.prototype.free=function(){this.data=null;};}
RastrTools.rgba=function(r,g,b,a){return((r&255)|((g&255)<<8)|((b&255)<<16)|((a&255)<<24))>>>0;};RastrTools.getR=function(clr){return(clr>>>0)&255;};RastrTools.getG=function(clr){return(clr>>>8)&255;};RastrTools.getB=function(clr){return(clr>>>16)&255;};RastrTools.getA=function(clr){return(clr>>>24)&255;};RastrTools.fetch=function(url,type,cb,user,pswrd){var r=new XMLHttpRequest();r.open("GET",url,true,user,pswrd);r.onload=()=>cb(r.response);r.onerror=()=>cb(new Error("Unable to fetch the module"));r.ontimeout=()=>cb(new Error("Request timed out"));r.timeout=10000;r.responseType=type;r.send(null);};